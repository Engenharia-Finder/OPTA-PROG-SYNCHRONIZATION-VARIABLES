# OPTA-PROG-SYNCHRONIZATION-VARIABLES
This programming aims to synchronize the last data read in the Arduino Cloud variable with a local variable. The step below this will be demonstrated below:

This programming simply counts pulses, where each pulse will be incremented by 0.002 in a widget, in addition we also have a virtual button connecting an OPTA output.

# 1° STEP

Create a local variable, in this case this variable named "contagem" is starting at 3,928

```
int estadoentrada1 = 0;
double contagem = 3.928;
bool conmuta = true;
```

![image](https://github.com/user-attachments/assets/64f7b77b-0847-4f0e-9860-f768d93d150b)


# 2° STEP

Create a variable in the Cloud to store these read values.
Create a variable in the Cloud to store these read values. In this case, a variable named "iniciado" was created.

```
/* 
  Sketch generated by the Arduino IoT Cloud Thing "Untitled"
  https://create.arduino.cc/cloud/things/7fe99baf-e042-457b-9c6f-d67a8a888f7f 

  Arduino IoT Cloud Variables description

  The following variables are automatically generated and updated when changes are made to the Thing

  float iniciado;
  CloudLight btn1;

  Variables which are marked as READ/WRITE in the Cloud Thing will also have functions
  which are called when their values are changed from the Dashboard.
  These functions are generated with the Thing and added at the end of this sketch.
*/
```
![image](https://github.com/user-attachments/assets/e27fec92-3001-4713-a5d1-4cf362a0d2c7)

# 3° STEP

Inside the void loop, increment a widget by 0.002 for each pulse received at a digital input of the OPTA.
contagem = contagem + 0.002; 

Then store this value in the Cloud variable:

iniciado = contagem;

```
void loop() {
  
  
  ArduinoCloud.update();
  // Your code here 

  estadoentrada1 = digitalRead(A0);
  if(estadoentrada1 == HIGH) {                           
      delay(5); 
      if (conmuta) { 
        Serial.print("Consumo kWh:  ");
        Serial.println(contagem);                                        
        contagem = contagem + 0.002; 
        iniciado = contagem;
        conmuta = false;                                    
      }
    }
    else {
      conmuta = true;                                       
    }

  if(btn1 == HIGH){
    digitalWrite(D0, HIGH);
    digitalWrite(LED_D0, HIGH);
  }else{
    digitalWrite(D0, LOW);
    digitalWrite(LED_D0, LOW);
  }
  
  
}

void doThisOnSync(){
  contagem = iniciado;
  Serial.println(contagem);
}

void doThisOnDisconnect(){
  Serial.println("OPTA está desconectado");
  if (ArduinoCloud.connected() == 0){
    disconnectAfter();
    while (false);
  }
  
}
```
![image](https://github.com/user-attachments/assets/cbcd687a-ad06-4446-8a59-0b7115a52344)

# 4° STEP

It is necessary to create the Arduino Cloud return functions within the Void setup.
These functions are intended to execute something in the programming according to the Cloud connection status.
The Cloud provides 3 functions:

- Synchronization
- Connected
- Disconnected

In this case, only the synchronization and disconnection functions were added, but we are only using the synchronization function in the programming, as it is the most important in this case.

```
void setup() {
  // Initialize serial and wait for port to open:
  Serial.begin(9600);
  // This delay gives the chance to wait for a Serial Monitor without blocking if none is found
  delay(1500); 

  // Defined in thingProperties.h
  initProperties();

  // Connect to Arduino IoT Cloud
  ArduinoCloud.begin(ArduinoIoTPreferredConnection);
  
  /*
     The following function allows you to obtain more information
     related to the state of network and IoT Cloud connection and errors
     the higher number the more granular information you’ll get.
     The default is 0 (only errors).
     Maximum is 4
 */
  setDebugMessageLevel(2);
  ArduinoCloud.printDebugInfo();

  ArduinoCloud.addCallback(ArduinoIoTCloudEvent::SYNC, doThisOnSync);
  ArduinoCloud.addCallback(ArduinoIoTCloudEvent::DISCONNECT, doThisOnDisconnect);

  pinMode(A0, INPUT);
  pinMode(D0, OUTPUT);
  pinMode(LED_D0, OUTPUT);

  
}
```

![image](https://github.com/user-attachments/assets/c6aabc1a-5027-4733-b991-1a01dc923bf1)


# 5° STEP
Let's create a function called "void doThisOnSync()" which will have the function of synchronizing the last value read in the Cloud variable with the variable stored in OPTA.

Let's create a function called "void doThisOnSync()" that will synchronize the last value read in the Cloud variable with the variable stored in OPTA.
After creating this function, it is necessary to add a small piece of code:

contagem = iniciado;

It is not necessary to include Serial.println(contagem);

```
void doThisOnSync(){
  contagem = iniciado;
  Serial.println(contagem);
}
```

![image](https://github.com/user-attachments/assets/755cd9ed-f905-4785-81c9-b84f80d94c78)


# CONCLUSION
The code with these functions is available here for consultation, the other files are not necessary for this synchronization, only the code snippets mentioned here are important.
